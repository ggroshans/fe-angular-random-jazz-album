<div *ngIf="albumLoading$ | async; else albumContent">Loading...</div>
<div *ngIf="albumError$ | async as ae">ERROR LOADING ALBUM: {{ ae }}</div>

<ng-template #albumContent>
  <div class="album-details__container" *ngIf="album$ | async as album" [@fadeIn]>
    <div class="album-details__top">
      <div class="album-details__top-left">
        <img
          [src]="album.imageUrl || '/placeholder.svg'"
          [alt]="album.title + ' by ' + getArtistString(album.artists || [])"
          class="album-details__cover"
        />
      </div>
      <div class="album-details__top-right">
        <div *ngIf="!album.title?.includes(':'); else albumTitleElseBlock">
          <mat-card-title class="album-details__title">{{ album.title }}</mat-card-title>
        </div>

        <ng-template #albumTitleElseBlock>
          <mat-card-title class="album-details__title album-details__title--part1">{{
            (album.title || '').split(':')[0] + ':'
          }}</mat-card-title>
          <mat-card-title class="album-details__title album-details__title--part2">{{
            (album.title || '').split(':')[1]
          }}</mat-card-title>
        </ng-template>
        <mat-card-subtitle class="album-details__artist">{{
          getArtistString(album.artists || [])
        }}</mat-card-subtitle>
        <mat-card-subtitle class="album-details__year">{{ album.releaseYear }}</mat-card-subtitle>

        <p class="album-details__description">"{{ album.description }}"</p>

        <div class="album-details__streaming-links">
          <a
            *ngIf="album.spotifyId"
            class="album-details__streaming-link-item album-details__streaming-link-item--spotify"
            [href]="'https://open.spotify.com/album/' + album.spotifyId"
            target="_blank"
          >
            <img
              class="album-details__streaming-icon"
              src="assets/brands/spotify.svg"
              alt="Spotify"
            />
          </a>
          <a
            *ngIf="album.youtubeId"
            class="album-details__streaming-link-item album-details__streaming-link-item--youtube-music"
            [href]="'https://music.youtube.com/playlist?list=' + album.youtubeId"
            target="_blank"
          >
            <img
              class="album-details__streaming-icon"
              src="assets/brands/youtubemusic.svg"
              alt="YouTube Music"
            />
          </a>
          <a
            *ngIf="album.amazonMusicId"
            class="album-details__streaming-link-item album-details__streaming-link-item--amazon-music"
            [href]="'https://music.amazon.com/albums/' + album.amazonMusicId"
            target="_blank"
          >
            <img
              class="album-details__streaming-icon"
              src="assets/brands/amazonmusic.svg"
              alt="Amazon Music"
            />
          </a>
          <a
            *ngIf="album.youtubeId"
            class="album-details__streaming-link-item album-details__streaming-link-item--youtube"
            [href]="'https://www.youtube.com/playlist?list=' + album.youtubeId"
            target="_blank"
          >
            <img
              class="album-details__streaming-icon"
              src="assets/brands/youtube.svg"
              alt="YouTube"
            />
          </a>
          <a
            *ngIf="album.pandoraId"
            class="album-details__streaming-link-item album-details__streaming-link-item--pandora"
            [href]="'https://www.pandora.com/' + album.pandoraId"
            target="_blank"
          >
            <img
              class="album-details__streaming-icon"
              src="assets/brands/pandora.svg"
              alt="Pandora"
            />
          </a>
          <a
            *ngIf="album.appleMusicId"
            class="album-details__streaming-link-item album-details__streaming-link-item--apple-music"
            [href]="
              'https://geo.music.apple.com/us/album/_/' +
              album.appleMusicId +
              '?mt=1&app=music&ls=1&at=1000lHKX&ct=api_http&itscg=30200&itsct=odsl_m'
            "
            target="_blank"
          >
            <img
              class="album-details__streaming-icon"
              src="assets/brands/applemusic.svg"
              alt="Apple Music"
            />
          </a>
        </div>
      </div>
    </div>

    <div class="album-details__mid">
      <div class="album-details__mid-left">
        <mat-accordion multi="false" class="album-details__accordion">
          <mat-expansion-panel class="album-details__expansion-panel">
            <mat-expansion-panel-header class="album-details__expansion-header">
              <mat-panel-title class="album-details__expansion-title"
                >Orig. Studio Release?</mat-panel-title
              >
            </mat-expansion-panel-header>
            <p class="album-details__expansion-content">
              {{ isOriginalReleaseResponse(album.isOriginalRelease) || '' }}
            </p>
          </mat-expansion-panel>

          <mat-expansion-panel class="album-details__expansion-panel">
            <mat-expansion-panel-header class="album-details__expansion-header">
              <mat-panel-title class="album-details__expansion-title">Genres</mat-panel-title>
            </mat-expansion-panel-header>
            <p class="album-details__expansion-content">{{ album.genres?.join(', ') || '' }}</p>
          </mat-expansion-panel>

          <mat-expansion-panel class="album-details__expansion-panel">
            <mat-expansion-panel-header class="album-details__expansion-header">
              <mat-panel-title class="album-details__expansion-title">Subgenres</mat-panel-title>
            </mat-expansion-panel-header>
            <p class="album-details__expansion-content">
              {{ getSubgenreString(album.subgenres || []) }}
            </p>
          </mat-expansion-panel>

          <mat-expansion-panel class="album-details__expansion-panel">
            <mat-expansion-panel-header class="album-details__expansion-header">
              <mat-panel-title class="album-details__expansion-title">Tracks</mat-panel-title>
            </mat-expansion-panel-header>
            <p class="album-details__expansion-content">
              {{ album.totalTracks?.toString() || '' }}
            </p>
          </mat-expansion-panel>
        </mat-accordion>
      </div>
      <div class="album-details__mid-right">
        <mat-accordion multi="false" class="album-details__accordion">
          <mat-expansion-panel class="album-details__expansion-panel">
            <mat-expansion-panel-header class="album-details__expansion-header">
              <mat-panel-title class="album-details__expansion-title">Theme</mat-panel-title>
            </mat-expansion-panel-header>
            <p class="album-details__expansion-content">{{ album.theme || '' }}</p>
          </mat-expansion-panel>

          <mat-expansion-panel class="album-details__expansion-panel">
            <mat-expansion-panel-header class="album-details__expansion-header">
              <mat-panel-title class="album-details__expansion-title">Label</mat-panel-title>
            </mat-expansion-panel-header>
            <p class="album-details__expansion-content">{{ album.label || '' }}</p>
          </mat-expansion-panel>

          <mat-expansion-panel class="album-details__expansion-panel">
            <mat-expansion-panel-header class="album-details__expansion-header">
              <mat-panel-title class="album-details__expansion-title">Mood</mat-panel-title>
            </mat-expansion-panel-header>
            <p class="album-details__expansion-content">
              {{ getMoodString(album.moods || []) || '' }}
            </p>
          </mat-expansion-panel>

          <mat-expansion-panel class="album-details__expansion-panel">
            <mat-expansion-panel-header class="album-details__expansion-header">
              <mat-panel-title class="album-details__expansion-title">Album #</mat-panel-title>
            </mat-expansion-panel-header>
            <p class="album-details__expansion-content">{{ album.label || '' }}</p>
          </mat-expansion-panel>
        </mat-accordion>
      </div>
    </div>

    <mat-divider class="album-details__divider"></mat-divider>

    <div class="album-details__bottom">
      <div class="album-details__bottom-left">
        <div class="album-details__popularity">
          <div class="album-details__popularity-item">
            <div class="album-details__popularity-label">
              <mat-icon class="album-details__popularity-icon">bar_chart</mat-icon>
              <span>Emotion Score: {{ getPercentileString(album.percentileScore || 0) }}</span>
            </div>
            <div class="album-details__progress-bar">
              <div
                [class]="
                  getProgressBarColor(album.percentileScore || 0) +
                  ' album-details__progress-bar-fill'
                "
                [ngStyle]="{
                  width: album.percentileScore + '%',
                  height: '0.5rem',
                }"
              ></div>
            </div>
          </div>

          <div class="album-details__popularity-item">
            <div class="album-details__popularity-label">
              <mat-icon class="album-details__popularity-icon">bar_chart</mat-icon>
              <span>Energy Score: {{ getPercentileString(album.percentileScore || 0) }}</span>
            </div>
            <div class="album-details__progress-bar">
              <div
                [class]="
                  getProgressBarColor(album.percentileScore || 0) +
                  ' album-details__progress-bar-fill'
                "
                [ngStyle]="{
                  width: album.percentileScore + '%',
                  height: '0.5rem',
                }"
              ></div>
            </div>
          </div>

          <div class="album-details__popularity-item">
            <div class="album-details__popularity-label">
              <mat-icon class="album-details__popularity-icon">bar_chart</mat-icon>
              <span>Percentile Score: {{ getPercentileString(album.percentileScore || 0) }}</span>
            </div>
            <div class="album-details__progress-bar">
              <div
                [class]="
                  getProgressBarColor(album.percentileScore || 0) +
                  ' album-details__progress-bar-fill'
                "
                [ngStyle]="{
                  width: album.percentileScore + '%',
                  height: '0.5rem',
                }"
              ></div>
            </div>
          </div>
        </div>
      </div>
      <div class="album-details__bottom-right">
        <div class="album-details__artist-info" *ngIf="album.artists && album.artists.length > 0">
          <div class="album-details__artist-header">
            <div>Artist</div>
          </div>
          <div class="album-details__artist-content">
            <div class="album-details__artist-image-wrapper">
              <img
                [src]="album.artists[0].imageUrl || '/placeholder.svg'"
                [alt]="album.artists[0].name"
                class="album-details__artist-image"
              />
            </div>
            <div class="album-details__artist-details">
              <h4 class="album-details__artist-name">{{ album.artists[0].name }}</h4>
              <div class="album-details__artist-popularity">
                <mat-icon class="album-details__artist-popularity-icon">bar_chart</mat-icon>
                <div class="album-details__artist-popularity-bar">
                  <div
                    [class]="
                      getProgressBarColor(album.artists[0].percentileScore) +
                      ' album-details__artist-popularity-fill'
                    "
                    [ngStyle]="{
                      width: album.artists[0].percentileScore + '%',
                      height: '0.25rem',
                    }"
                  ></div>
                </div>
                <span class="album-details__artist-popularity-score"
                  >{{ album.artists[0].percentileScore }}%</span
                >
              </div>
              <p class="album-details__artist-bio">{{ album.artists[0].biography }}</p>
            </div>
          </div>

          <button
            (click)="goToArtistDetail(album.artists[0].id)"
            mat-stroked-button
            class="album-details__view-profile-button"
          >
            View Artist Profile
            <span class="album-details__view-profile-button-icon material-icons">
              subdirectory_arrow_right
            </span>
          </button>
        </div>

        <div class="album-details__actions">
          <button
            mat-raised-button
            color="accent"
            class="album-details__action-button album-details__action-button--add-to-collection"
          >
            Add to Collection
          </button>
          <button
            mat-stroked-button
            class="album-details__action-button album-details__action-button--share-album"
          >
            Share Album
          </button>
        </div>
      </div>
    </div>
  </div>
</ng-template>
